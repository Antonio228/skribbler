// ==UserScript==
// @name Skribbler
// @namespace https://rosshill.ca
// @match *://skribbl.io/*
// @version 2.2.3
// @author Ross Hill
// @downloadURL https://raw.githubusercontent.com/rosslh/skribbler/master/skribbler.user.js
// @icon https://skribbl.io/res/favicon.png
// @homepageURL https://github.com/rosslh/skribbler
// @connect skribbler.herokuapp.com
// @require http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js
// @grant GM.xmlHttpRequest
// @grant GM_xmlhttpRequest
// ==/UserScript==

// This code has been compiled and minified. The source code and build script can be found on Github.

var c={pattern:"",content:document.createElement("span"),wordsList:$(document.createElement("ul")),prevClue:"",links:document.createElement("strong"),prevAnswer:""};function i(){$("#screenGame").is(":visible")&&$(this).scrollTop()<$("#screenGame").offset().top&&$("html, body").animate({scrollTop:$("#screenGame").offset().top},1e3)}function u(e,t){var n=$(".drawing").is(":visible"),r=e.replace(/_/g,"").length;return!(!n||!(0<unsafeWindow.dictionary.oneOffWords.length||t<=r&&r!==e.length))||(n||(unsafeWindow.dictionary.validAnswers=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.oneOffWords=[]),!1)}function f(){return!!$(".guessedWord .info .name[style='color: rgb(0, 0, 255);']").length&&(unsafeWindow.dictionary.validAnswers=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.oneOffWords=[],!0)}function o(e,t){for(var n=1;n<t.length+1;n++)if(e===t.substring(0,n-1)+t.substring(n,t.length))return!0;return!1}function p(e,t){if(e.length===t.length){for(var n=0,r=0;r<e.length;r++)if(e.charAt(r)!==t.charAt(r)&&(n+=1),1<n)return!1;return 1===n}return e.length===t.length-1?o(e,t):t.length===e.length-1&&o(t,e)}function h(e,t){if(-1!==unsafeWindow.dictionary.guessed.indexOf(t))return!1;var n=!0,r=!1,o=void 0;try{for(var i,s=unsafeWindow.dictionary.oneOffWords[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){if(!p(t,i.value))return!1}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}var a=!0,d=!1,l=void 0;try{for(var u,c=e[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){if(p(t,u.value))return!1}}catch(e){d=!0,l=e}finally{try{!a&&c.return&&c.return()}finally{if(d)throw l}}return!0}function w(e){return new RegExp("^"+e.replace(/_/g,"[^- ]")+"$")}function y(e){var t=unsafeWindow.dictionary,n=void 0;0===t.validAnswers.length?(n=t.confirmed.slice(),t.standard.forEach(function(e){-1===n.indexOf(e)&&n.push(e)})):n=t.validAnswers;var r=[];c.pattern=w(e);var o=[];if(t.guessed.forEach(function(e){-1===t.oneOffWords.indexOf(e)&&o.push(e)}),!f()){var i=!0,s=!1,a=void 0;try{for(var d,l=n[Symbol.iterator]();!(i=(d=l.next()).done);i=!0){var u=d.value;u.length===e.length&&c.pattern.test(u)&&h(o,u)&&r.push(u)}}catch(e){s=!0,a=e}finally{try{!i&&l.return&&l.return()}finally{if(s)throw a}}}return unsafeWindow.dictionary.validAnswers=r}function s(e){var t=$(document.createElement("ul"));if(t.css({width:"70%",margin:"0 auto","margin-top":"10px","background-color":"#eee",padding:"4px","border-radius":"2px","list-style-position":"inside",columns:"4",display:c.wordsList.css("display"),visibility:c.wordsList.css("visibility")}),u(e,0)&&!f()){var n=y(e),r=!0,o=!1,i=void 0;try{for(var s,a=n[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var d=s.value,l=document.createElement("li");l.innerText=d,t[0].appendChild(l)}}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}}c.wordsList.html(t.html())}function a(){return $("#currentWord")}function d(){return a()[0].textContent.toLowerCase()}function l(){var e,t=void 0!==(e=$(".info .name[style='color: rgb(0, 0, 255);")[0])?e.innerText.split(" (")[0]:"";t&&$("#boxMessages p[style='color: rgb(0, 0, 0);'] b:contains("+t+":)").parent().find("span").not(".skribblerHandled").slice(-10).each(function(e,t){var n=t.innerText;-1===unsafeWindow.dictionary.guessed.indexOf(n)&&(unsafeWindow.dictionary.guessed.push(n),t.classList.add("skribblerHandled"),s(d()))})}function g(){return $("#inputChat")}function v(){var e=d(),t=g()[0],n=e.length-t.value.length;c.content.textContent=n,c.content.style.color="unset",0<n?(c.content.textContent="+"+c.content.textContent,c.content.style.color="green"):n<0&&(c.content.style.color="red"),c.pattern=w(e);var r=w(e.substring(0,t.value.length));c.pattern.test(t.value.toLowerCase())?t.style.border="3px solid green":r.test(t.value.toLowerCase())?t.style.border="3px solid orange":t.style.border="3px solid red"}function m(){var e,t=d();t!==c.prevClue&&(c.prevClue=t,v(),s(t),0<(e=t).length&&-1===e.indexOf("_")?(c.links.innerHTML="<a style='color: blue' target='_blank' href='https://www.google.ca/search?tbm=isch&q="+e+"'>Images</a>, ",c.links.innerHTML+="<a style='color: blue' target='_blank' href='https://www.google.ca/search?tbm=isch&tbs=itp:lineart&q="+e+"'>Line art</a>"):c.links.innerHTML="")}function b(e,t){var n,r,o,i=$("#overlay .content .text")[0].innerText;"The word was: "===i.slice(0,14)&&(i=i.slice(14))!==c.prevAnswer&&(c.prevAnswer=i,unsafeWindow.dictionary.oneOffWords=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.validAnswers=[],n=i,r=e,o=t,GM.xmlHttpRequest({method:"POST",data:JSON.stringify({word:n}),headers:{"Content-Type":"application/json",Authorization:"Basic "+btoa(r+":"+o)},url:"https://skribbler.herokuapp.com/api/words",onload:function(e){(e.status<200||300<=e.status)&&409!==e.status&&alert("Could not add '"+n+"' to your confirmed words.")}}))}function x(e,t){$("#audio").css({left:"unset",right:"0px"}),window.setInterval(i,2e3),$(c.links).css({padding:"0 1em 0 1em"}),a().after(c.links);var n=$("#formChat")[0];$(c.content).css({position:"relative",left:"295px",top:"-25px"}),c.wordsList.css({width:"70%",margin:"0 auto","margin-top":"10px","background-color":"#eee",padding:"4px","border-radius":"2px","list-style-position":"inside",columns:"4"}),n.appendChild(c.content),$("#screenGame")[0].appendChild(c.wordsList[0]),g()[0].style.border="3px solid orange",window.setInterval(function(){m(),b(e,t),$("#boxMessages p[style='color: rgb(204, 204, 0); font-weight: bold;'] span:contains( is close!)").not(".skribblerHandled").slice(-10).each(function(e,t){var n=t.innerText.split("'")[1];-1===unsafeWindow.dictionary.oneOffWords.indexOf(n)&&(unsafeWindow.dictionary.oneOffWords.push(n),t.classList.add("skribblerHandled"),s(d()))}),l(),$(c.wordsList).is(":visible")?0!==c.wordsList.children().length&&!f()&&u(d(),0)||c.wordsList.hide():c.wordsList.is(":hidden")&&0<c.wordsList.children().length&&!f()&&u(d(),0)&&c.wordsList.show(),$(".modal-dialog:contains(Are you still here?)").is(":visible")&&document.hidden&&alert("Action required.")},1e3),$("#formChat").append($('<div style="background-color:#eee; position:relative; top:-20px; padding:0 5px; width:auto; margin:0;"><input id="guessEnabled" name="guessEnabled" style="width:5px; height:5px; filter: brightness(0.8);" type="checkbox"><label for="guessEnabled" style="all: initial; padding-left:5px;">Enable auto-guesser</label></div>'));var r=0,o=0;window.setInterval(function(){$("#guessEnabled").is(":checked")&&1500<Date.now()-o&&1500<Date.now()-r&&(r=Date.now(),function(e){if(u(e,1)&&!f()){var t=y(e),n=[];t.forEach(function(e){-1<unsafeWindow.dictionary.confirmed.indexOf(e)&&n.push(e)});var r=void 0;r=0<n.length?n[Math.floor(Math.random()*n.length)]:t[Math.floor(Math.random()*t.length)];var o=Object.keys(unsafeWindow.formChat).filter(function(e){return~e.indexOf("jQuery")})[0];window.setTimeout(function(){""===g().val()&&u(e,1)&&!f()&&(g().val(r),unsafeWindow.formChat[o].events.submit[0].handler())},Math.floor(800*Math.random()))}}(d()))},1e3),g().keyup(function(){o=Date.now()}),g().keyup(v)}function W(n,r){GM.xmlHttpRequest({method:"GET",url:"https://skribbler.herokuapp.com/api/default",headers:{Authorization:"Basic "+btoa(n+":"+r)},onload:function(e){unsafeWindow.dictionary.standard=JSON.parse(e.responseText),GM.xmlHttpRequest({method:"GET",url:"https://skribbler.herokuapp.com/api/words",headers:{Authorization:"Basic "+btoa(n+":"+r)},onload:function(e){if(e.status<300&&200<=e.status){alert("Login successful, words retrieved."),unsafeWindow.dictionary.confirmed=JSON.parse(e.responseText);var t=window.setInterval(function(){a()&&(clearInterval(t),x(n,r))},500)}else alert("Words not retrieved. Please try again later.")}})}})}function k(){var t,n,e=void 0,r=void 0,o=prompt("Have you already created your skribbler account? (yes/no)").toLowerCase();"yes"===o?W(e=prompt("Please enter your skribbler username").toLowerCase(),r=prompt("Please enter your skribbler password")):"no"===o?(e=prompt("Please enter a username").toLowerCase(),(r=prompt("Please enter a unique password"))===prompt("Reenter password")&&(t=e,n=r,GM.xmlHttpRequest({method:"POST",data:JSON.stringify({username:t,password:n}),headers:{"Content-Type":"application/json"},url:"https://skribbler.herokuapp.com/api/users",onload:function(e){201===e.status?(alert("User created."),W(t,n)):409===e.status?alert("User already exists. Please reload and try another username."):alert("User creation unsuccessful. Please try again later.")}}))):k()}unsafeWindow.dictionary={standard:[],confirmed:[],oneOffWords:[],guessed:[],validAnswers:[]},$(document).ready(function(){"undefined"==typeof GM&&(GM={xmlHttpRequest:GM_xmlhttpRequest});var e=$("<button>Activate skribbler</button>");e.css({"font-size":"0.6em"}),$(".loginPanelTitle").first().append(e),e.click(function(){e.hide(),k()})});