// ==UserScript==
// @author Ross Hill <rosshill.ca>
// @connect skribbler.herokuapp.com
// @grant GM_xmlhttpRequest
// @grant GM.xmlHttpRequest
// @homepageURL https://github.com/rosslh/skribbler
// @icon https://skribbl.io/res/favicon.png
// @licence MIT
// @match *://skribbl.io/*
// @name Skribbler
// @namespace https://rosshill.ca
// @require http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js
// @supportURL https://github.com/rosslh/skribbler/issues
// @version 2.5.10
// ==/UserScript==

// This code has been compiled and minified. The source code and build script can be found on Github.

var u={content:document.createElement("span"),links:document.createElement("strong"),pattern:"",prevAnswer:"",prevClue:"",wordsList:$(document.createElement("ul"))};function o(){$("#screenGame").is(":visible")&&$("html").scrollTop()<$("#screenGame").offset().top&&$("html, body").animate({scrollTop:$("#screenGame").offset().top},1e3)}function l(e,n){var t=$(".drawing").is(":visible"),i=e.replace(/_|-| /g,"").length,r=e.replace(/_/g,"").length;return!(!t||!(0<unsafeWindow.dictionary.oneOffWords.length||n<=i&&r!==e.length))||(t||(unsafeWindow.dictionary.validAnswers=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.oneOffWords=[]),!1)}function c(){return!!$('.guessedWord .info .name[style="color: rgb(0, 0, 255);"]').length&&(unsafeWindow.dictionary.validAnswers=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.oneOffWords=[],!0)}function r(e,n){for(var t=1;t<n.length+1;t++)if(e===n.substring(0,t-1)+n.substring(t,n.length))return!0;return!1}function s(e,n){if(e.length===n.length){for(var t=0,i=0;i<e.length;i++)if(e.charAt(i)!==n.charAt(i)&&(t+=1),1<t)return!1;return 1===t}return e.length===n.length-1?r(e,n):n.length===e.length-1&&r(n,e)}function f(e){return new RegExp("^"+e.replace(/_/g,"[^- ]")+"$")}function p(e,n,t){return e.filter(function(e){return e.length===t.length&&u.pattern.test(e)&&function(e,n){if(-1!==unsafeWindow.dictionary.guessed.indexOf(n))return!1;for(var t=0,i=unsafeWindow.dictionary.oneOffWords;t<i.length;t++)if(!s(n,i[t]))return!1;for(var r=0,o=e;r<o.length;r++)if(s(n,o[r]))return!1;return!0}(n,e)}).sort()}function a(e){var n=$(document.createElement("ul"));if(l(e,0)&&!c())for(var t=0,i=function(e){var n,t=unsafeWindow.dictionary;if(0===t.validAnswers.length){n=t.confirmed.slice();for(var i=0,r=t.standard;i<r.length;i++){var o=r[i];-1===n.indexOf(o)&&n.push(o)}}else n=t.validAnswers;u.pattern=f(e);for(var s=[],a=0,d=t.guessed;a<d.length;a++){var l=d[a];-1===t.oneOffWords.indexOf(l)&&s.push(l)}return c()?t.validAnswers=[]:t.validAnswers=p(n,s,e),t.validAnswers}(e);t<i.length;t++){var r=i[t],o=document.createElement("li"),s=$("<span onClick=\"submitGuess('"+r+"')\">"+r+"</span>");s.css({cursor:"pointer",textDecoration:"underline",textDecorationStyle:"dotted"}),-1<unsafeWindow.dictionary.confirmed.indexOf(r)&&s.css({fontWeight:"bold"}),$(o).append(s),n.append(o)}u.wordsList.html(n.html()),u.wordsList.css({width:$(document).width()-$("#containerChat").width()-40+"px"})}function d(){return $("#currentWord")}function g(){return d()[0].textContent.toLowerCase()}function h(){var e,n=void 0!==(e=$('.info .name[style="color: rgb(0, 0, 255);')[0])?e.innerText.split(" (")[0]:"";n&&$("#boxMessages p[style='color: rgb(0, 0, 0);'] b:contains("+n+":)").parent().find("span").not(".skribblerHandled").slice(-10).each(function(e,n){var t=n.innerText;-1===unsafeWindow.dictionary.guessed.indexOf(t)&&(unsafeWindow.dictionary.guessed.push(t),n.classList.add("skribblerHandled"),a(g()))})}function w(){var e=g(),n=unsafeWindow.getInput()[0],t=e.length-n.value.length;u.content.textContent=t,u.content.style.color="unset",0<t?(u.content.textContent="+"+u.content.textContent,u.content.style.color="green"):t<0&&(u.content.style.color="red"),u.pattern=f(e);var i=f(e.substring(0,n.value.length));u.pattern.test(n.value.toLowerCase())?n.style.border="3px solid green":i.test(n.value.toLowerCase())?n.style.border="3px solid orange":n.style.border="3px solid red"}function v(){var e,n=g();n!==u.prevClue&&(u.prevClue=n,w(),a(n),0<(e=n).length&&-1===e.indexOf("_")?(u.links.innerHTML="<a style='color: blue' target='_blank'\nhref='https://www.google.ca/search?tbm=isch&q="+e+"'>Images</a>, ",u.links.innerHTML+="<a style='color: blue' target='_blank'\nhref='https://www.google.ca/search?tbm=isch&tbs=itp:lineart&q="+e+"'>Line art</a>"):u.links.innerHTML="")}function b(e){if(l(e,1)&&!c()){for(var n=unsafeWindow.dictionary.validAnswers,t=[],i=0,r=n;i<r.length;i++){var o=r[i];-1<unsafeWindow.dictionary.confirmed.indexOf(o)&&t.push(o)}var s=void 0;s=0<t.length?t[Math.floor(Math.random()*t.length)]:n[Math.floor(Math.random()*n.length)],a=s,d=e,window.setTimeout(function(){""===unsafeWindow.getInput().val()&&l(d,1)&&!c()&&unsafeWindow.submitGuess(a)},Math.floor(Math.random()*(Number($("#guessRate").val())/3)))}var a,d}function m(i,r){$("#audio").css({left:"unset",right:"0px"}),window.setInterval(o,2e3),$(u.links).css({padding:"0 1em 0 1em"}),d().after(u.links);var e=$("#formChat")[0];$(u.content).css({left:"295px",position:"relative",top:"-25px"}),u.wordsList.css({"background-color":"#eee","border-radius":"2px",columns:"4","list-style-position":"inside","margin-top":"10px",padding:"4px",width:"70%"}),e.appendChild(u.content),$("#screenGame")[0].appendChild(u.wordsList[0]),unsafeWindow.getInput()[0].style.border="3px solid orange",window.setInterval(function(){var e,n,t;v(),e=i,n=r,"The word was: "===(t=$("#overlay .content .text")[0].innerText).slice(0,14)&&(t=t.slice(14))!==u.prevAnswer&&(u.prevAnswer=t,unsafeWindow.dictionary.oneOffWords=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.validAnswers=[],x&&y(t,e,n)),$("#boxMessages p[style='color: rgb(204, 204, 0); font-weight: bold;'] span:contains( is close!)").not(".skribblerHandled").slice(-10).each(function(e,n){var t=n.innerText.split("'")[1];-1===unsafeWindow.dictionary.oneOffWords.indexOf(t)&&(unsafeWindow.dictionary.oneOffWords.push(t),n.classList.add("skribblerHandled"),a(g()))}),h(),$(u.wordsList).is(":visible")?0!==u.wordsList.children().length&&!c()&&l(g(),0)||u.wordsList.hide():0<u.wordsList.children().length&&!c()&&l(g(),0)&&u.wordsList.show(),document.hidden&&$(".modal-dialog:contains(Are you still here?)").is(":visible")&&alert("Action required.")},1e3),$("#boxChatInput").append($('<div style="background-color:#eee; position:relative;\ntop:-20px; padding:0 5px; width:auto; margin:0;">\n<input id="guessEnabled" name="guessEnabled" style="width:6px; height:6px;" type="checkbox">\n<label for="guessEnabled" style="all: initial; padding-left:5px;">Enable auto-guesser</label><br>\n<label for="guessRate" style="all: initial; padding-right:5px;">Guess frequency (seconds):</label>\n<input id="guessRate" name="guessRate" type="number" step="0.5" min="1" value="1.5" style="width:4em;"></div>'));var n=0,t=0;window.setInterval(function(){$("#guessEnabled").is(":checked")&&1500<=Date.now()-t&&Date.now()-n>=1e3*Number($("#guessRate").val())&&(n=Date.now(),b(g()))},500),unsafeWindow.getInput().keyup(function(){t=Date.now()}),unsafeWindow.getInput().keyup(w)}unsafeWindow.dictionary={confirmed:[],guessed:[],oneOffWords:[],standard:[],validAnswers:[]},unsafeWindow.getInput=function(){return $("#inputChat")},unsafeWindow.submitGuess=function(e){var n=Object.keys(unsafeWindow.formChat).filter(function(e){return~e.indexOf("jQuery")})[0];unsafeWindow.getInput().val(e),unsafeWindow.formChat[n].events.submit[0].handler()},$(document).ready(function(){var e;"undefined"==typeof GM&&(GM={xmlHttpRequest:GM_xmlhttpRequest}),(e=x?$("<button>Activate skribbler (admin)</button>"):$("<button>Activate skribbler</button>")).css({"font-size":"0.6em"}),$(".loginPanelTitle").first().append(e),e.click(function(){var i,r;e.hide(),x?n():(r=i="",GM.xmlHttpRequest({method:"GET",url:"https://skribbler.herokuapp.com/api/words",onload:function(e){var n=JSON.parse(e.responseText);unsafeWindow.dictionary.standard=n.default,unsafeWindow.dictionary.confirmed=n.confirmed;var t=window.setInterval(function(){d()&&(clearInterval(t),m(i,r))},1e3)}}))})});var y=function(e,n,t){},n=function(){},x=!1;