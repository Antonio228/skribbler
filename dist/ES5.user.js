// ==UserScript==
// @name Skribbler
// @namespace https://rosshill.ca
// @match *://skribbl.io/*
// @version 2.4.0
// @author Ross Hill
// @icon https://skribbl.io/res/favicon.png
// @connect skribbler.herokuapp.com
// @homepageURL https://github.com/rosslh/skribbler
// @require http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js
// @grant GM.xmlHttpRequest
// @grant GM_xmlhttpRequest
// ==/UserScript==

// This code has been compiled and minified. The source code and build script can be found on Github.

var u={content:document.createElement("span"),links:document.createElement("strong"),pattern:"",prevAnswer:"",prevClue:"",wordsList:$(document.createElement("ul"))};function o(){$("#screenGame").is(":visible")&&$("html").scrollTop()<$("#screenGame").offset().top&&$("html, body").animate({scrollTop:$("#screenGame").offset().top},1e3)}function d(e,n){var t=$(".drawing").is(":visible"),r=e.replace(/_|-| /g,"").length,i=e.replace(/_/g,"").length;return!(!t||!(0<unsafeWindow.dictionary.oneOffWords.length||n<=r&&i!==e.length))||(t||(unsafeWindow.dictionary.validAnswers=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.oneOffWords=[]),!1)}function c(){return!!$('.guessedWord .info .name[style="color: rgb(0, 0, 255);"]').length&&(unsafeWindow.dictionary.validAnswers=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.oneOffWords=[],!0)}function i(e,n){for(var t=1;t<n.length+1;t++)if(e===n.substring(0,t-1)+n.substring(t,n.length))return!0;return!1}function s(e,n){if(e.length===n.length){for(var t=0,r=0;r<e.length;r++)if(e.charAt(r)!==n.charAt(r)&&(t+=1),1<t)return!1;return 1===t}return e.length===n.length-1?i(e,n):n.length===e.length-1&&i(n,e)}function f(e){return new RegExp("^"+e.replace(/_/g,"[^- ]")+"$")}function h(e,n,t){return e.filter(function(e){return e.length===t.length&&u.pattern.test(e)&&function(e,n){if(-1!==unsafeWindow.dictionary.guessed.indexOf(n))return!1;for(var t=0,r=unsafeWindow.dictionary.oneOffWords;t<r.length;t++)if(!s(n,r[t]))return!1;for(var i=0,o=e;i<o.length;i++)if(s(n,o[i]))return!1;return!0}(n,e)}).sort()}function a(e){var n=$(document.createElement("ul"));if(d(e,0)&&!c())for(var t=0,r=function(e){var n,t=unsafeWindow.dictionary;if(0===t.validAnswers.length){n=t.confirmed.slice();for(var r=0,i=t.standard;r<i.length;r++){var o=i[r];-1===n.indexOf(o)&&n.push(o)}}else n=t.validAnswers;u.pattern=f(e);for(var s=[],a=0,d=t.guessed;a<d.length;a++){var l=d[a];-1===t.oneOffWords.indexOf(l)&&s.push(l)}return c()?t.validAnswers=[]:t.validAnswers=h(n,s,e),t.validAnswers}(e);t<r.length;t++){var i=r[t],o=document.createElement("li");-1<unsafeWindow.dictionary.confirmed.indexOf(i)?o.innerHTML="<strong>"+i+"</strong>":o.innerText=i,n[0].appendChild(o)}u.wordsList.html(n.html()),u.wordsList.css({width:$(document).width()-$("#containerChat").width()-40+"px"})}function l(){return $("#currentWord")}function g(){return l()[0].textContent.toLowerCase()}function p(){var e,n=void 0!==(e=$('.info .name[style="color: rgb(0, 0, 255);')[0])?e.innerText.split(" (")[0]:"";n&&$("#boxMessages p[style='color: rgb(0, 0, 0);'] b:contains("+n+":)").parent().find("span").not(".skribblerHandled").slice(-10).each(function(e,n){var t=n.innerText;-1===unsafeWindow.dictionary.guessed.indexOf(t)&&(unsafeWindow.dictionary.guessed.push(t),n.classList.add("skribblerHandled"),a(g()))})}function w(){return $("#inputChat")}function v(){var e=g(),n=w()[0],t=e.length-n.value.length;u.content.textContent=t,u.content.style.color="unset",0<t?(u.content.textContent="+"+u.content.textContent,u.content.style.color="green"):t<0&&(u.content.style.color="red"),u.pattern=f(e);var r=f(e.substring(0,n.value.length));u.pattern.test(n.value.toLowerCase())?n.style.border="3px solid green":r.test(n.value.toLowerCase())?n.style.border="3px solid orange":n.style.border="3px solid red"}function b(){var e,n=g();n!==u.prevClue&&(u.prevClue=n,v(),a(n),0<(e=n).length&&-1===e.indexOf("_")?(u.links.innerHTML="<a style='color: blue' target='_blank'\nhref='https://www.google.ca/search?tbm=isch&q="+e+"'>Images</a>, ",u.links.innerHTML+="<a style='color: blue' target='_blank'\nhref='https://www.google.ca/search?tbm=isch&tbs=itp:lineart&q="+e+"'>Line art</a>"):u.links.innerHTML="")}function m(r,i){$("#audio").css({left:"unset",right:"0px"}),window.setInterval(o,2e3),$(u.links).css({padding:"0 1em 0 1em"}),l().after(u.links);var e=$("#formChat")[0];$(u.content).css({left:"295px",position:"relative",top:"-25px"}),u.wordsList.css({"background-color":"#eee","border-radius":"2px",columns:"4","list-style-position":"inside","margin-top":"10px",padding:"4px",width:"70%"}),e.appendChild(u.content),$("#screenGame")[0].appendChild(u.wordsList[0]),w()[0].style.border="3px solid orange",window.setInterval(function(){var e,n,t;b(),e=r,n=i,"The word was: "===(t=$("#overlay .content .text")[0].innerText).slice(0,14)&&(t=t.slice(14))!==u.prevAnswer&&(u.prevAnswer=t,unsafeWindow.dictionary.oneOffWords=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.validAnswers=[],x&&y(t,e,n)),$("#boxMessages p[style='color: rgb(204, 204, 0); font-weight: bold;'] span:contains( is close!)").not(".skribblerHandled").slice(-10).each(function(e,n){var t=n.innerText.split("'")[1];-1===unsafeWindow.dictionary.oneOffWords.indexOf(t)&&(unsafeWindow.dictionary.oneOffWords.push(t),n.classList.add("skribblerHandled"),a(g()))}),p(),$(u.wordsList).is(":visible")?0!==u.wordsList.children().length&&!c()&&d(g(),0)||u.wordsList.hide():0<u.wordsList.children().length&&!c()&&d(g(),0)&&u.wordsList.show(),document.hidden&&$(".modal-dialog:contains(Are you still here?)").is(":visible")&&alert("Action required.")},1e3),$("#boxChatInput").append($('<div style="background-color:#eee; position:relative;\ntop:-20px; padding:0 5px; width:auto; margin:0;">\n<input id="guessEnabled" name="guessEnabled" style="width:6px; height:6px;" type="checkbox">\n<label for="guessEnabled" style="all: initial; padding-left:5px;">Enable auto-guesser</label><br>\n<label for="guessRate" style="all: initial; padding-right:5px;">Guess frequency (seconds):</label>\n<input id="guessRate" name="guessRate" type="number" step="0.5" min="1" value="1.5" style="width:4em;"></div>'));var n=0,t=0;window.setInterval(function(){$("#guessEnabled").is(":checked")&&1500<=Date.now()-t&&Date.now()-n>=1e3*Number($("#guessRate").val())&&(n=Date.now(),function(e){if(d(e,1)&&!c()){for(var n,t=unsafeWindow.dictionary.validAnswers,r=[],i=0,o=t;i<o.length;i++){var s=o[i];-1<unsafeWindow.dictionary.confirmed.indexOf(s)&&r.push(s)}n=0<r.length?r[Math.floor(Math.random()*r.length)]:t[Math.floor(Math.random()*t.length)];var a=Object.keys(unsafeWindow.formChat).filter(function(e){return~e.indexOf("jQuery")})[0];window.setTimeout(function(){""===w().val()&&d(e,1)&&!c()&&(w().val(n),unsafeWindow.formChat[a].events.submit[0].handler())},Math.floor(Math.random()*(Number($("#guessRate").val())/3)))}}(g()))},500),w().keyup(function(){t=Date.now()}),w().keyup(v)}unsafeWindow.dictionary={confirmed:[],guessed:[],oneOffWords:[],standard:[],validAnswers:[]},$(document).ready(function(){var e;"undefined"==typeof GM&&(GM={xmlHttpRequest:GM_xmlhttpRequest}),(e=x?$("<button>Activate skribbler (admin)</button>"):$("<button>Activate skribbler</button>")).css({"font-size":"0.6em"}),$(".loginPanelTitle").first().append(e),e.click(function(){var r,i;e.hide(),x?n():(i=r="",GM.xmlHttpRequest({method:"GET",url:"https://skribbler.herokuapp.com/api/words",onload:function(e){var n=JSON.parse(e.responseText);unsafeWindow.dictionary.standard=n.default,unsafeWindow.dictionary.confirmed=n.confirmed;var t=window.setInterval(function(){l()&&(clearInterval(t),m(r,i))},1e3)}}))})});var y=function(e,n,t){},n=function(){},x=!1;