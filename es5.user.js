// ==UserScript==
// @name Skribbler
// @namespace https://rosshill.ca
// @match *://skribbl.io/*
// @version 2.3.0
// @author Ross Hill
// @icon https://skribbl.io/res/favicon.png
// @homepageURL https://github.com/rosslh/skribbler
// @connect skribbler.herokuapp.com
// @require http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js
// @grant GM.xmlHttpRequest
// @grant GM_xmlhttpRequest
// ==/UserScript==

// This code has been compiled and minified. The source code and build script can be found on Github.

var w={pattern:"",content:document.createElement("span"),wordsList:$(document.createElement("ul")),prevClue:"",links:document.createElement("strong"),prevAnswer:""};function a(){$("#screenGame").is(":visible")&&$(this).scrollTop()<$("#screenGame").offset().top&&$("html, body").animate({scrollTop:$("#screenGame").offset().top},1e3)}function c(e,t){var n=$(".drawing").is(":visible"),r=e.replace(/_|-| /g,"").length;return!(!n||!(0<unsafeWindow.dictionary.oneOffWords.length||t<=r&&r!==e.length))||(n||(unsafeWindow.dictionary.validAnswers=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.oneOffWords=[]),!1)}function v(){return!!$(".guessedWord .info .name[style='color: rgb(0, 0, 255);']").length&&(unsafeWindow.dictionary.validAnswers=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.oneOffWords=[],!0)}function o(e,t){for(var n=1;n<t.length+1;n++)if(e===t.substring(0,n-1)+t.substring(n,t.length))return!0;return!1}function f(e,t){if(e.length===t.length){for(var n=0,r=0;r<e.length;r++)if(e.charAt(r)!==t.charAt(r)&&(n+=1),1<n)return!1;return 1===n}return e.length===t.length-1?o(e,t):t.length===e.length-1&&o(t,e)}function g(e,t){if(-1!==unsafeWindow.dictionary.guessed.indexOf(t))return!1;var n=!0,r=!1,o=void 0;try{for(var a,i=unsafeWindow.dictionary.oneOffWords[Symbol.iterator]();!(n=(a=i.next()).done);n=!0){if(!f(t,a.value))return!1}}catch(e){r=!0,o=e}finally{try{!n&&i.return&&i.return()}finally{if(r)throw o}}var s=!0,l=!1,d=void 0;try{for(var u,c=e[Symbol.iterator]();!(s=(u=c.next()).done);s=!0){if(f(t,u.value))return!1}}catch(e){l=!0,d=e}finally{try{!s&&c.return&&c.return()}finally{if(l)throw d}}return!0}function m(e){return new RegExp("^"+e.replace(/_/g,"[^- ]")+"$")}function u(e){var t=unsafeWindow.dictionary,n=void 0;if(0===t.validAnswers.length){n=t.confirmed.slice();var r=!0,o=!1,a=void 0;try{for(var i,s=t.standard[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var l=i.value;-1===n.indexOf(l)&&n.push(l)}}catch(e){o=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw a}}}else n=t.validAnswers;w.pattern=m(e);var d=[],u=!0,c=!1,f=void 0;try{for(var p,h=t.guessed[Symbol.iterator]();!(u=(p=h.next()).done);u=!0){var y=p.value;-1===t.oneOffWords.indexOf(y)&&d.push(y)}}catch(e){c=!0,f=e}finally{try{!u&&h.return&&h.return()}finally{if(c)throw f}}return v()?t.validAnswers=[]:t.validAnswers=function(e,t,n){var r=[],o=!0,a=!1,i=void 0;try{for(var s,l=e[Symbol.iterator]();!(o=(s=l.next()).done);o=!0){var d=s.value;d.length===n.length&&w.pattern.test(d)&&g(t,d)&&r.push(d)}}catch(e){a=!0,i=e}finally{try{!o&&l.return&&l.return()}finally{if(a)throw i}}return r.sort()}(n,d,e),t.validAnswers}function i(e){var t=$(document.createElement("ul"));if(c(e,0)&&!v()){var n=u(e),r=!0,o=!1,a=void 0;try{for(var i,s=n[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var l=i.value,d=document.createElement("li");-1<unsafeWindow.dictionary.confirmed.indexOf(l)?d.innerHTML="<strong>"+l+"</strong>":d.innerText=l,t[0].appendChild(d)}}catch(e){o=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw a}}}w.wordsList.html(t.html()),w.wordsList.css({width:$(document).width()-$("#containerChat").width()-15+"px"})}function s(){return $("#currentWord")}function l(){return s()[0].textContent.toLowerCase()}function d(){var e,t=void 0!==(e=$(".info .name[style='color: rgb(0, 0, 255);")[0])?e.innerText.split(" (")[0]:"";t&&$("#boxMessages p[style='color: rgb(0, 0, 0);'] b:contains("+t+":)").parent().find("span").not(".skribblerHandled").slice(-10).each(function(e,t){var n=t.innerText;-1===unsafeWindow.dictionary.guessed.indexOf(n)&&(unsafeWindow.dictionary.guessed.push(n),t.classList.add("skribblerHandled"),i(l()))})}function p(){return $("#inputChat")}function h(){var e=l(),t=p()[0],n=e.length-t.value.length;w.content.textContent=n,w.content.style.color="unset",0<n?(w.content.textContent="+"+w.content.textContent,w.content.style.color="green"):n<0&&(w.content.style.color="red"),w.pattern=m(e);var r=m(e.substring(0,t.value.length));w.pattern.test(t.value.toLowerCase())?t.style.border="3px solid green":r.test(t.value.toLowerCase())?t.style.border="3px solid orange":t.style.border="3px solid red"}function y(){var e,t=l();t!==w.prevClue&&(w.prevClue=t,h(),i(t),0<(e=t).length&&-1===e.indexOf("_")?(w.links.innerHTML="<a style='color: blue' target='_blank' href='https://www.google.ca/search?tbm=isch&q="+e+"'>Images</a>, ",w.links.innerHTML+="<a style='color: blue' target='_blank' href='https://www.google.ca/search?tbm=isch&tbs=itp:lineart&q="+e+"'>Line art</a>"):w.links.innerHTML="")}function b(e,t){var n,r,o,a=$("#overlay .content .text")[0].innerText;"The word was: "===a.slice(0,14)&&(a=a.slice(14))!==w.prevAnswer&&(w.prevAnswer=a,unsafeWindow.dictionary.oneOffWords=[],unsafeWindow.dictionary.guessed=[],unsafeWindow.dictionary.validAnswers=[],n=a,r=e,o=t,GM.xmlHttpRequest({method:"POST",data:JSON.stringify({word:n}),headers:{"Content-Type":"application/json",Authorization:"Basic "+btoa(r+":"+o)},url:"https://skribbler.herokuapp.com/api/words",onload:function(e){(e.status<200||300<=e.status)&&409!==e.status&&alert("Could not add '"+n+"' to your confirmed words.")}}))}function x(e,t){$("#audio").css({left:"unset",right:"0px"}),window.setInterval(a,2e3),$(w.links).css({padding:"0 1em 0 1em"}),s().after(w.links);var n=$("#formChat")[0];$(w.content).css({position:"relative",left:"295px",top:"-25px"}),w.wordsList.css({width:"70%","margin-top":"10px","background-color":"#eee",padding:"4px","border-radius":"2px","list-style-position":"inside",columns:"4"}),n.appendChild(w.content),$("#screenGame")[0].appendChild(w.wordsList[0]),p()[0].style.border="3px solid orange",window.setInterval(function(){y(),b(e,t),$("#boxMessages p[style='color: rgb(204, 204, 0); font-weight: bold;'] span:contains( is close!)").not(".skribblerHandled").slice(-10).each(function(e,t){var n=t.innerText.split("'")[1];-1===unsafeWindow.dictionary.oneOffWords.indexOf(n)&&(unsafeWindow.dictionary.oneOffWords.push(n),t.classList.add("skribblerHandled"),i(l()))}),d(),$(w.wordsList).is(":visible")?0!==w.wordsList.children().length&&!v()&&c(l(),0)||w.wordsList.hide():0<w.wordsList.children().length&&!v()&&c(l(),0)&&w.wordsList.show(),document.hidden&&$(".modal-dialog:contains(Are you still here?)").is(":visible")&&alert("Action required.")},1e3),$("#boxChatInput").append($('<div style="background-color:#eee; position:relative; top:-20px; padding:0 5px; width:auto; margin:0;">\n<input id="guessEnabled" name="guessEnabled" style="width:6px; height:6px;" type="checkbox">\n<label for="guessEnabled" style="all: initial; padding-left:5px;">Enable auto-guesser</label><br>\n<label for="guessRate" style="all: initial; padding-right:5px;">Guess frequency (seconds):</label>\n<input id="guessRate" name="guessRate" type="number" step="0.5" min="1" value="1.5" style="width:4em;"></div>'));var r=0,o=0;window.setInterval(function(){$("#guessEnabled").is(":checked")&&1500<=Date.now()-o&&Date.now()-r>=1e3*$("#guessRate").val()&&(r=Date.now(),function(e){if(c(e,1)&&!v()){var t=unsafeWindow.dictionary.validAnswers,n=[],r=!0,o=!1,a=void 0;try{for(var i,s=t[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var l=i.value;-1<unsafeWindow.dictionary.confirmed.indexOf(l)&&n.push(l)}}catch(e){o=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw a}}var d=void 0;d=0<n.length?n[Math.floor(Math.random()*n.length)]:t[Math.floor(Math.random()*t.length)];var u=Object.keys(unsafeWindow.formChat).filter(function(e){return~e.indexOf("jQuery")})[0];window.setTimeout(function(){""===p().val()&&c(e,1)&&!v()&&(p().val(d),unsafeWindow.formChat[u].events.submit[0].handler())},Math.floor(800*Math.random()))}}(l()))},1e3),p().keyup(function(){o=Date.now()}),p().keyup(h)}function W(n,r){GM.xmlHttpRequest({method:"GET",url:"https://skribbler.herokuapp.com/api/default",headers:{Authorization:"Basic "+btoa(n+":"+r)},onload:function(e){unsafeWindow.dictionary.standard=JSON.parse(e.responseText),GM.xmlHttpRequest({method:"GET",url:"https://skribbler.herokuapp.com/api/words",headers:{Authorization:"Basic "+btoa(n+":"+r)},onload:function(e){if(e.status<300&&200<=e.status){alert("Login successful, words retrieved."),unsafeWindow.dictionary.confirmed=JSON.parse(e.responseText);var t=window.setInterval(function(){s()&&(clearInterval(t),x(n,r))},500)}else alert("Words not retrieved. Please try again later.")}})}})}function k(){var t,n,e=void 0,r=void 0,o=prompt("Have you already created your skribbler account? (yes/no)").toLowerCase();"yes"===o?W(e=prompt("Please enter your skribbler username").toLowerCase(),r=prompt("Please enter your skribbler password")):"no"===o?(e=prompt("Please enter a username").toLowerCase(),(r=prompt("Please enter a unique password"))===prompt("Reenter password")&&(t=e,n=r,GM.xmlHttpRequest({method:"POST",data:JSON.stringify({username:t,password:n}),headers:{"Content-Type":"application/json"},url:"https://skribbler.herokuapp.com/api/users",onload:function(e){201===e.status?(alert("User created."),W(t,n)):409===e.status?alert("User already exists. Please reload and try another username."):alert("User creation unsuccessful. Please try again later.")}}))):k()}unsafeWindow.dictionary={standard:[],confirmed:[],oneOffWords:[],guessed:[],validAnswers:[]},$(document).ready(function(){"undefined"==typeof GM&&(GM={xmlHttpRequest:GM_xmlhttpRequest});var e=$("<button>Activate skribbler</button>");e.css({"font-size":"0.6em"}),$(".loginPanelTitle").first().append(e),e.click(function(){e.hide(),k()})});